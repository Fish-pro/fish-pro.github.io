---
layout: post
title: 实践测试：使用 SR-IOV CNI 提升容器网络性能
author: chatgpt 3.5
tags:
- 容器网络
date: 2024-01-24 01:56 +0800
---
在容器化环境中，网络性能对于高性能应用和大规模部署至关重要。Single Root I/O Virtualization（SR-IOV）是一种技术，通过将物理网络适配器划分为多个虚拟适配器，可以显著提升容器网络性能。本文将介绍如何在 Kubernetes 中实践测试 SR-IOV CNI，以验证其在容器网络中的性能优势。

### 准备工作

在开始测试之前，请确保你已完成以下准备工作：

1. **硬件支持：** 服务器上的网络适配器必须支持 SR-IOV，并通过 BIOS 或 UEFI 启用了 SR-IOV 功能。

2. **Kubernetes 集群：** 你需要一个运行中的 Kubernetes 集群，确保已正确安装并配置了 SR-IOV CNI 插件。

### 安装 SR-IOV CNI 插件和 Device Plugin

首先，让我们安装 SR-IOV CNI 插件和 SR-IOV Device Plugin。以下是简单的安装步骤：

```bash
# 克隆 SR-IOV CNI 仓库
git clone https://github.com/intel/sriov-cni.git

# 进入 sriov-cni 目录
cd sriov-cni

# 构建并安装插件
make
```

```bash
# 克隆 SR-IOV Device Plugin 仓库
git clone https://github.com/intel/sriov-network-device-plugin.git

# 进入 sriov-network-device-plugin 目录
cd sriov-network-device-plugin

# 构建并安装插件
make
```

### 创建 SR-IOV CNI 配置文件

创建 SR-IOV CNI 的配置文件，例如 `sriov-cni-config.json`，以指定 SR-IOV 网卡的相关信息。确保配置文件中的参数符合你的硬件和网络设置。

```json
// sriov-cni-config.json
{
  "cniVersion": "0.4.0",
  "name": "sriov-cni",
  "type": "sriov",
  "vlan": 100
}
```

### 创建 SR-IOV Device Plugin DaemonSet

创建设备插件 DaemonSet，以便在集群的每个节点上启动 sriov-device-plugin。

```bash
kubectl create -f sriov-network-device-plugin/deployments/sriovdp-daemonset.yaml
```

### 更新性能测试 Pod

更新之前创建的性能测试 Pod YAML 文件 `sriov-test-pod.yaml`，以便在 Pod 中声明需要使用 SR-IOV VF。

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: sriov-test-pod
spec:
  containers:
  - name: sriov-test-container
    image: nginx
    resources:
      requests:
        memory: "64Mi"
        cpu: "250m"
      limits:
        memory: "128Mi"
        cpu: "500m"
    volumeMounts:
    - name: sriov-net-cfg
      mountPath: /etc/cni/net.d
  volumes:
  - name: sriov-net-cfg
    hostPath:
      path: /etc/cni/net.d
  - name: sriov-fs
    hostPath:
      path: /var/lib/sriov
```

### 部署更新后的测试 Pod

```bash
kubectl apply -f sriov-test-pod.yaml
```

等待 Pod 运行，并确保它成功启动。

### 验证安装是否成功

执行以下验证步骤，以确保 SR-IOV CNI 和 SR-IOV Device Plugin 安装成功：

#### 验证 SR-IOV CNI

1. **检查 SR-IOV CNI 插件是否在 Kubernetes 集群中正常运行：**

    ```bash
    kubectl get pods -n kube-system | grep sriov
    ```

    确保 sriov-cni 组件的 Pods 在运行状态。

2. **查看 SR-IOV CNI 的配置文件是否正确加载：**

    ```bash
    kubectl get configmap sriov-cni-config -n kube-system -o yaml
    ```

    确保配置文件中包含了正确的 SR-IOV 网卡配置。

#### 验证 SR-IOV Device Plugin

1. **检查 SR-IOV Device Plugin 是否在 Kubernetes 集群中正常运行：**

    ```bash
    kubectl get pods -n kube-system | grep sriov-device-plugin
    ```

    确保 sriov-device-plugin 组件的 Pods 在运行状态。

2. **查看 SR-IOV Device Plugin 的节点资源是否正确注册：**

    ```bash
    kubectl get nodes -o json | jq '.items[].status.allocatable'
    ```

    确保 allocatable 字段中包含了 SR-IOV VF 相关的资源。

3. **检查是否有 GPU 类型的资源被正确注册：**

    ```bash
    kubectl describe node <Your_Node_Name> | grep sriov
    ```

    替换 `<Your_Node_Name>` 为你的节点名称。确保输出中包含了 SR-IOV VF 相关的信息。

### 运行网络性能测试

在测试 Pod 内运行网络性能测试，例如使用 iperf 工具。首先，在测试 Pod 中运行 iperf 服务器：

```bash
kubectl exec -it sriov-test-pod -- iperf3 -s
```

然后，在另一个节点上运行 iperf 客户端测试：

```bash
kubectl run -it --rm --restart=Never iperf-client --image=networkstatic/iperf3 -- iperf3 -c <Pod_IP_Address>
```

替换 `<Pod_IP_Address>` 为测试 Pod 的 IP 地址。观察测试结果，确保性能测试正常运行。

### 结论

通过执行这些步骤，我们成功地安装和配置了 SR-IOV CNI 和 SR-IOV Device Plugin，并验证了容器网络性能的提升。结合 SR-IOV 技术

，我们能够在容器化环境中更好地满足对高吞吐量和低延迟的网络需求。在实际应用中，建议结合具体的应用场景和性能需求，调整 SR-IOV CNI 和 sriov-device-plugin 的配置以实现最佳性能。
